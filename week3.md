# Week 3: Fuzzing Libraries

In this exercise, we will rediscover a vulnerability in the [libexif](https://libexif.github.io/) library, which parses Exif image metadata.
A library can't be executed on its own, so we'll need to compile an executable program that uses the library.
One executable that we can use is the [exif](https://github.com/libexif/exif) tool provided by the libexif project.
In later weeks we will show how to write your own executable to achieve much better performance.

This time, we will not be giving you the exact commands to execute, so you'll have to figure them out yourselves.
If you're not sure what to do, you can try reading documentation, which you can find by searching online, running `man <command_name>`, or running a command with the `--help` option.
You can refer back to [last week's exercise](week2.md).

This exercise is based on [Fuzzing101 Exercise 2](https://github.com/antonio-morales/Fuzzing101/tree/main/Exercise%202).

## Docker

If you're done with last week's exercise, you can delete the Docker container with `docker rm fuzz_xpdf`.
**This will permanently delete the container without asking for confirmation.**

We've updated the Dockerfile, so run `git pull` inside the repository or redownload it manually.
Then, rerun the command to build the image create a new container named `fuzz_libexif`.
We also uploaded the image to Docker Hub, so if you're on an x86-64 machine (basically anything other than Apple Silicon), you can pull the prebuilt image from Docker Hub instead of building it locally.
Simply replace `fuzz` with `jivi149/fuzz` in your `docker run` command and Docker will automatically download the image if it isn't already on your machine.
If you use the image from Docker Hub, you can delete the old image with `docker rmi fuzz`.

## Building libexif

Inside the Docker container, download libexif from <https://github.com/libexif/libexif/archive/refs/tags/libexif-0_6_14-release.tar.gz> and extract the archive.
Move into the resulting directory.
Before compiling libexif, we need to install some of its dependencies.
We can do this using Fedora's DNF package manager by running `dnf install libtool gettext-devel popt-devel`.
libexif doesn't include a `configure` script inside its repository, so we have to generate one by running `autoreconf -fvi`.
You can run `autoreconf --help` to see what the options do.

Now is a good time to mention the difference between static linking and dynamic linking.
These are the two ways in which an executable's code can be linked to the libraries that it uses.
In static linking, the library's code is copied into the executable file at build time.
On the other hand, dynamically linked libraries, also called shared libraries, are stored in separate files.
When the program is executed, a dynamic linker finds the libraries and links the executable with them.
Linux programs are usually dynamically linked, but when fuzzing we want to use static linking since we want to avoid having to mess with libary search paths in order to make the dynamic linker find the right libraries.

Build and install libexif.
When you run the `configure` script, add the `--enable-shared=no` option to disable the generation of shared library files.
Remember to use the Honggfuzz compiler and set the install prefix.

## Building exif

Go back to the `/fuzz` directory.
Download the exif source code from <https://github.com/libexif/exif/archive/refs/tags/exif-0_6_15-release.tar.gz> and extract the archive, then build and install exif.
When running the `configure` script, add `PKG_CONFIG_PATH=/fuzz/install/lib/pkgconfig` to the end.
This option helps the build system find the libexif libary that we just installed.

Return to the `/fuzz` directory once again.
If you try running the `exif` program that you just built, you should see a help message.

## Fuzzing

For our seed corpus, download some samples of images with Exif metadata from <https://github.com/ianare/exif-samples/archive/refs/heads/master.zip> and extract the archive using `unzip master.zip`.
Try running `exif` on one of the images in the resulting directory.
It should print out information about the image.
Now run Honggfuzz using the files in the `exif-samples-master/jpg` directory as the seed corpus.
The only argument to the target program should be the input file generated by the fuzzer.
You should get a crash after a while, but it may take up to half an hour.
After you get the crash, you can examine `HONGGFUZZ.REPORT.TXT` and try to debug it if you want.
