# Week 3: Coverage-Guided Fuzzing & Fuzzing Libraries

This week, we will be learning more about **coverage-guided fuzzing**, which is the main technique used in modern fuzzers.
Often times, when performing fuzzing, some memory corruption bugs **do not crash the program** making them harder to detect.
Using binary instrumentation, we can use tools like **sanitizers** to make it easier to detect these bugs and measure **code coverage**.
Often times, the programs we need to fuzz are not standalone executables, but **shared libraries** (especially in the case of larger projects).

This week, we will cover all of these topics by rediscovering a vulnerability in the [libexif](https://libexif.github.io/) library, which parses Exif image metadata.
A library can't be executed on its own, so we'll need to compile an executable program that uses the library (in this case, the [exif](https://github.com/libexif/exif) program).

> [!NOTE]
> This week's exercise will have less commands provided so you can get a chance to try and figure things out in preparation for the project!
> If you forgot how to run a command or need an explanation on a fuzzing concept, you can refer back to [last week's exercise](02-intro-to-fuzzing.md).
> Please ask for help if you're stuck, we're here to help!

# Week 3: Fuzzing Libraries

In this exercise, we will rediscover a vulnerability in the [libexif](https://libexif.github.io/) library, which parses Exif image metadata.
A library can't be executed on its own, so we'll need to compile an executable program that uses the library.
One executable that we can use is the [exif](https://github.com/libexif/exif) tool provided by the libexif project.
In later weeks we will show how to write your own executable to achieve much better performance.

This time, we will not be giving you the exact commands to execute, so you'll have to figure them out yourselves.
If you're not sure what to do, you can try reading documentation, which you can find by searching online, running `man <command_name>`, or running a command with the `--help` option.
You can refer back to [last week's exercise](week2.md).

## Building libexif

Inside the Docker container, download libexif from <https://github.com/libexif/libexif/archive/refs/tags/libexif-0_6_14-release.tar.gz> and extract the archive.
Move into the resulting directory.
Before compiling libexif, we need to install some of its dependencies.
We can do this using Fedora's DNF package manager by running `dnf install libtool gettext-devel popt-devel`.
libexif doesn't include a `configure` script inside its repository, so we have to generate one by running `autoreconf -fvi`.
You can run `autoreconf --help` to see what the options do.

Now is a good time to mention the difference between static linking and dynamic linking.
These are the two ways in which an executable's code can be linked to the libraries that it uses.
In static linking, the library's code is copied into the executable file at build time.
On the other hand, dynamically linked libraries, also called shared libraries, are stored in separate files.
When the program is executed, a dynamic linker finds the libraries and links the executable with them.
Linux programs are usually dynamically linked, but when fuzzing we want to use static linking since we want to avoid having to mess with libary search paths in order to make the dynamic linker find the right libraries.

Build and install libexif.
When you run the `configure` script, add the `--enable-shared=no` option to disable the generation of shared library files.
Remember to use the Honggfuzz compiler and set the install prefix.

## Building exif

Go back to the `/fuzz` directory.
Download the exif source code from <https://github.com/libexif/exif/archive/refs/tags/exif-0_6_15-release.tar.gz> and extract the archive, then build and install exif.
When running the `configure` script, add `PKG_CONFIG_PATH=/fuzz/install/lib/pkgconfig` to the end.
This option helps the build system find the libexif libary that we just installed.

Return to the `/fuzz` directory once again.
If you try running the `exif` program that you just built, you should see a help message.

## Fuzzing

For our seed corpus, download some samples of images with Exif metadata from <https://github.com/ianare/exif-samples/archive/refs/heads/master.zip> and extract the archive using `unzip master.zip`.
Try running `exif` on one of the images in the resulting directory.
It should print out information about the image.
Now run Honggfuzz using the files in the `exif-samples-master/jpg` directory as the seed corpus.
The only argument to the target program should be the input file generated by the fuzzer.
You should get a crash after a while, but it may take up to half an hour.
After you get the crash, you can examine `HONGGFUZZ.REPORT.TXT` and try to debug it if you want.

## Acknowledgements
This exercise is based on [Fuzzing101 Exercise 2](https://github.com/antonio-morales/Fuzzing101/tree/main/Exercise%202).
